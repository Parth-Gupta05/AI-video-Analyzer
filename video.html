<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Hazard Detection Stream</title>
  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#0f1720;
      --accent:#00d1b2;
      --danger:#ff4d4f;
      --muted:#9aa4b2;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      --gap:12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{height:100%;margin:0;background:linear-gradient(180deg,#03060a 0%, #07111a 100%);color:#e6eef6}
    .app{
      min-height:100%;display:flex;flex-direction:column;gap:16px;align-items:center;justify-content:center;padding:18px;
    }

    .card{
      width:min(1180px,98vw);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(6px);border-radius:var(--radius);overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)
    }

    .header{
      display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--panel);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#4dd0ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021018}
    .title{font-weight:600}
    .subtitle{font-size:12px;color:var(--muted);margin-top:3px}

    .content{display:grid;grid-template-columns:1fr 320px;gap:16px;padding:18px}

    .video-wrap{position:relative;background:var(--glass);border-radius:10px;overflow:hidden;min-height:56vh;display:flex;align-items:stretch}
    video{width:100%;height:100%;object-fit:cover;background:#000}

    /* overlay controls over the video */
    .overlay{
      position:absolute;left:12px;bottom:12px;display:flex;flex-direction:column;gap:10px;z-index:5
    }
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(0,0,0,0.45);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.03)}
    .status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger);box-shadow:0 0 8px rgba(255,77,79,0.5)}
    .status-ok{background:var(--accent);box-shadow:0 0 10px rgba(0,209,178,0.35)}

    /* right panel */
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:14px;border-radius:10px;min-height:56vh;display:flex;flex-direction:column;gap:12px}
    .controls{display:flex;gap:10px;flex-wrap:wrap}

    button{appearance:none;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--accent);color:#021018}
    .btn-ghost{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.04)}
    .btn-danger{background:var(--danger);color:#120606}

    .small{font-size:13px;padding:8px 10px}

    .info{font-size:13px;color:var(--muted)}

    .log{flex:1;overflow:auto;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px;border:1px dashed rgba(255,255,255,0.02);font-family:monospace;font-size:13px}

    .footer{padding:12px 18px;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:space-between}

    /* responsive */
    @media (max-width:980px){
      .content{grid-template-columns:1fr}
      .panel{min-height:220px}
    }

    /* simple toast */
    .toast{position:fixed;right:18px;bottom:18px;padding:12px 16px;border-radius:10px;background:#06121a;color:#e6f7f3;box-shadow:0 8px 30px rgba(0,0,0,0.6)}

  </style>
</head>
<body>
  <div class="app">
    <div class="card" role="application">
      <div class="header">
        <div class="brand">
          <div class="logo">LD</div>
          <div>
            <div class="title">Live Hazard Detection</div>
            <div class="subtitle">Edge-first | Laptop-friendly | Cloud-optional</div>
          </div>
        </div>
        <div class="info">Status: <strong id="connectionText">Idle</strong></div>
      </div>

      <div class="content">
        <div class="video-wrap">
          <video id="video" autoplay playsinline muted></video>

          <div class="overlay">
            <div class="pill">
              <div id="recDot" class="status-dot"></div>
              <div id="recLabel">Not recording</div>
            </div>

            <div class="pill" id="hazardBadge" style="display:none;background:rgba(255,77,79,0.16);color:#ffbcbc;border:1px solid rgba(255,77,79,0.15)">
              ⚠️ <span id="hazardText" style="margin-left:8px">Hazard detected</span>
            </div>
          </div>
        </div>

        <aside class="panel" aria-label="Controls and logs">
          <div>
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div class="info">Camera: <strong id="cameraLabel">—</strong></div>
              <div class="info">Clip: <strong id="clipDuration">3s</strong></div>
            </div>

            <div class="controls" style="margin-top:10px">
              <button id="recordButton" class="btn-primary">Start</button>
              <button id="switchButton" class="btn-ghost small">Switch Camera</button>
              <button id="muteButton" class="btn-ghost small">Mute</button>
              <button id="downloadButton" class="btn-ghost small">Download Last</button>
              <button id="sendButton" class="btn-ghost small">Send Now</button>
              <button id="clearLog" class="btn-ghost small">Clear Log</button>
            </div>
          </div>

          <div class="info">Upload endpoint: <code id="endpoint">https://model-forge-idfe.onrender.com/api/detect</code></div>

          <div class="log" id="log" role="log" aria-live="polite">Ready.</div>

        </aside>
      </div>

      <div class="footer">
        <div class="info">Edge-first recording for privacy — works on laptops & phones.</div>
        <div class="info">Built: Compact stream + chunked uploads</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    // Designed for wider browser compatibility: use webm when available, fall back to default.
    const endpointEl = document.getElementById('endpoint');
    const endpoint = endpointEl.textContent.trim();

    const video = document.getElementById('video');
    const recDot = document.getElementById('recDot');
    const recLabel = document.getElementById('recLabel');
    const recordButton = document.getElementById('recordButton');
    const logEl = document.getElementById('log');
    const toastEl = document.getElementById('toast');
    const clipDurationEl = document.getElementById('clipDuration');
    const hazardBadge = document.getElementById('hazardBadge');
    const hazardText = document.getElementById('hazardText');
    const downloadButton = document.getElementById('downloadButton');
    const sendButton = document.getElementById('sendButton');
    const muteButton = document.getElementById('muteButton');
    const switchButton = document.getElementById('switchButton');

    let stream = null;
    let recorder = null;
    let chunks = [];
    let isRecording = false;
    let lastBlob = null;
    let currentFacingMode = 'environment';
    let clipMs = 3000; // default clip length

    function log(msg){
      const time = new Date().toLocaleTimeString();
      logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
    }

    function showToast(msg, ms=3000){
      toastEl.textContent = msg; toastEl.style.display='block';
      setTimeout(()=> toastEl.style.display='none', ms);
    }

    async function startStream(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode }, audio: false });
        video.srcObject = stream;
        document.getElementById('cameraLabel').textContent = currentFacingMode;
        log('Camera started.');
      }catch(err){
        log('Camera error: ' + err.message);
        showToast('Cannot access camera. Check permissions.');
        throw err;
      }
    }

    function getMime(){
      if(MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) return 'video/webm;codecs=vp9';
      if(MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) return 'video/webm;codecs=vp8';
      if(MediaRecorder.isTypeSupported('video/mp4')) return 'video/mp4';
      return '';
    }

    function updateUIRecording(){
      if(isRecording){
        recDot.classList.remove('status-ok'); recDot.classList.add('status-dot');
        recDot.style.background = 'var(--danger)';
        recLabel.textContent = 'Recording';
        recordButton.textContent = 'Stop';
        recordButton.classList.add('btn-danger');
      }else{
        recDot.style.background = 'transparent';
        recLabel.textContent = 'Not recording';
        recordButton.textContent = 'Start';
        recordButton.classList.remove('btn-danger');
      }
    }

    async function startRecordingLoop(){
      if(!stream) await startStream();

      const mime = getMime();
      recorder = new MediaRecorder(stream, mime ? { mimeType: mime } : undefined);
      chunks = [];

      recorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };

      recorder.onstop = async () => {
        lastBlob = new Blob(chunks, { type: chunks[0]?.type || 'video/webm' });
        chunks = [];
        log('Clip recorded (' + Math.round(lastBlob.size/1024) + 'KB)');
        downloadButton.disabled = false;
        sendButton.disabled = false;

        // auto-send to server (base64) -- convert and post
        try{
          const b64 = await blobToBase64(lastBlob);
          await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ video: b64 }) });
          log('Uploaded clip to server');
        }catch(err){
          log('Upload failed: '+ err.message);
        }

        // restart clip if still recording
        if(isRecording) {
          recorder.start();
          setTimeout(()=> recorder.stop(), clipMs);
        }
      };

      // start first clip
      recorder.start();
      setTimeout(()=> recorder.stop(), clipMs);
    }

    function blobToBase64(blob){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = ()=> res(r.result.split(',')[1]);
        r.onerror = rej;
        r.readAsDataURL(blob);
      });
    }

    recordButton.addEventListener('click', async ()=>{
      try{
        isRecording = !isRecording;
        updateUIRecording();
        if(isRecording){
          await startRecordingLoop();
          log('Recording loop started.');
        }else{
          // stop recorder and camera
          if(recorder && recorder.state !== 'inactive') recorder.stop();
          if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; video.srcObject = null; }
          log('Recording stopped.');
        }
      }catch(err){ log('Start failed: '+ err.message); isRecording=false; updateUIRecording(); }
    });

    downloadButton.addEventListener('click', ()=>{
      if(!lastBlob) return showToast('No recorded clip yet');
      const url = URL.createObjectURL(lastBlob);
      const a = document.createElement('a'); a.href = url; a.download = 'clip.webm'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      log('Downloaded last clip');
    });

    sendButton.addEventListener('click', async ()=>{
      if(!lastBlob) return showToast('No recorded clip yet');
      try{
        const b64 = await blobToBase64(lastBlob);
        await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ video: b64 }) });
        log('Manual upload complete');
        showToast('Uploaded');
      }catch(err){ log('Manual upload failed: '+err.message); showToast('Upload failed'); }
    });

    muteButton.addEventListener('click', ()=>{
      video.muted = !video.muted; muteButton.textContent = video.muted ? 'Unmute' : 'Mute';
    });

    switchButton.addEventListener('click', async ()=>{
      currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
      if(stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; }
      await startStream();
      log('Switched camera to '+currentFacingMode);
    });

    document.getElementById('clearLog').addEventListener('click', ()=> logEl.textContent = '');

    // Expose a simple hazard badge trigger for demo/testing
    window.triggerHazard = (text='Hazard detected') => {
      hazardText.textContent = text; hazardBadge.style.display = 'flex';
      setTimeout(()=> hazardBadge.style.display = 'none', 5000);
    };

    // Initialize small UI state
    updateUIRecording();
    clipDurationEl.textContent = (clipMs/1000) + 's';

    log('UI ready — click Start to allow camera and begin chunked recording.');

  </script>
</body>
</html>
